name: Pipeline CI

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Instalar dependências
      run: pip install -r requirements.txt

    - name: Instalar Java (OpenJDK 11)
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jdk

    - name: Configurar JAVA_HOME
      run: echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

    - name: Adicionar exercicios ao PYTHONPATH
      run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

    - name: Executar Testes Unitários
      run: pytest tests/unit --maxfail=1 --disable-warnings --html=reports/unit.html --self-contained-html

    - name: Upload Unit Report
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-report
        path: reports/unit.html

  integration-tests:
    name: Integration Tests (Spark + Iceberg + Hive + HDFS)
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose-plugin

      - name: Build & start services
        run: |
          docker compose -f docker/docker-compose.grader.yml up -d --build
          # Espera Metastore responder na porta 9083
          timeout 180 bash -c 'until nc -z localhost 9083; do sleep 3; done'
          # Espera NameNode UI
          timeout 180 bash -c 'until nc -z localhost 9870; do sleep 3; done'

      - name: Run integration tests inside grader
        run: |
          docker compose -f docker/docker-compose.grader.yml run --rm grader \
            pytest tests/integration --maxfail=1 --disable-warnings \
              --html=reports/integration.html --self-contained-html
          # Copia relatório do container para o host
          docker compose -f docker/docker-compose.grader.yml cp grader:/home/jovyan/work/reports/integration.html reports/integration.html || true

      - name: Upload integration report
        uses: actions/upload-artifact@v4
        with:
          name: integration-report
          path: reports/integration.html

      - name: Calculate Weighted Grade and Export CSV
        run: |
          RA="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"

          # Define pesos
          declare -A weights=(
            ["ex06"]=0.5
            ["ex07"]=0.5
            ["ex08"]=1.0
            ["ex09"]=1.0
            ["ex10"]=1.0
            ["ex11"]=1.0
            ["ex12"]=1.0
            ["ex13"]=1.0
            ["ex14"]=0.5
            ["ex15"]=0.5
            ["ex16"]=1.0
            ["ex17"]=1.0
            ["ex18"]=1.0
            ["ex19"]=1.0
            ["ex20"]=0.5
          )

          TOTAL_POSSIBLE=0
          TOTAL_GAINED=0

          for test_file in tests/integration/test_ex*.py; do
            ex_name=$(basename "$test_file" .py | sed 's/test_//')
            weight=${weights[$ex_name]:-0}
            TOTAL_POSSIBLE=$(awk "BEGIN {print $TOTAL_POSSIBLE + $weight}")

            if pytest "$test_file" --disable-warnings --quiet; then
              TOTAL_GAINED=$(awk "BEGIN {print $TOTAL_GAINED + $weight}")
            fi
          done

          # Normaliza para escala 0-10
          GRADE=$(awk "BEGIN {printf \"%.2f\", ($TOTAL_GAINED/$TOTAL_POSSIBLE)*10}")

          mkdir -p reports
          echo "RA,Nota" > reports/nota.csv
          echo "$RA,$GRADE" >> reports/nota.csv

      - name: Upload Grade CSV
        uses: actions/upload-artifact@v4
        with:
          name: nota-${{ steps.grade.outputs.ra }}
          path: reports/nota.csv

      - name: Shutdown services
        if: always()
        run: docker compose -f docker/docker-compose.grader.yml down -v

      - name: Salvar Nota do Aluno (RA = branch)
        run: |
          RA="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          TOTAL=$(pytest tests/integration --maxfail=1 --disable-warnings --quiet 2>&1 | grep -oP '\d+(?= passed|\sfailed)' | head -1)
          PASSED=$(pytest tests/integration --maxfail=1 --disable-warnings --quiet 2>&1 | grep -oP '\d+(?= passed)' | head -1)

          TOTAL=${TOTAL:-0}
          PASSED=${PASSED:-0}

          if [ "$TOTAL" -eq 0 ]; then
            GRADE=0
          else
            GRADE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL)*10}")
          fi

          mkdir -p notas
          echo "RA,Nota" > notas/${RA}.csv
          echo "$RA,$GRADE" >> notas/${RA}.csv

      - name: Upload Nota do Aluno
        uses: actions/upload-artifact@v4
        with:
          name: notas
          path: notas/
